<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Queens: Mechanical Speed Analytics</title>
    <style>
        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f3f2ef;
            color: #1d1148;
            margin: 0;
            touch-action: none;
            user-select: none;
        }

        h1 { margin: 20px 0 5px 0; font-size: 1.5rem; }
        .subtitle { color: #666; margin-bottom: 20px; font-size: 0.9rem; text-align: center; max-width: 90%; }

        #timer {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            color: #0073b1;
            min-width: 250px;
            text-align: center;
        }

        #game-container {
            position: relative;
            width: 350px;
            height: 350px;
            border: 4px solid #000;
            background: #fff;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        #grid-cover {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(29, 17, 72, 0.98);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }

        #queens-grid {
            display: grid;
            grid-template-columns: repeat(7, 50px);
            grid-template-rows: repeat(7, 50px);
        }

        .cell {
            width: 50px;
            height: 50px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 0.5px solid rgba(0,0,0,0.1);
            position: relative;
        }

        .color-purple { background-color: #b39ddb; }
        .color-orange { background-color: #ffcc80; }
        .color-blue { background-color: #90caf9; }
        .color-green { background-color: #a5d6a7; }
        .color-grey { background-color: #e0e0e0; }
        .color-red { background-color: #ef9a9a; }
        .color-yellow { background-color: #fff59d; }

        .thick-border-right { border-right: 4px solid #000 !important; }
        .thick-border-bottom { border-bottom: 4px solid #000 !important; }

        .queen-icon {
            font-size: 32px;
            color: #000;
            opacity: 0.8; 
            pointer-events: none;
            transition: color 0.1s ease;
        }
        
        .found .queen-icon { color: #0a66c2; opacity: 1; }
        .mark { color: rgba(0,0,0,0.1); font-size: 18px; pointer-events: none; }

        .btn {
            background: #0a66c2;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
        }

        #stats-panel {
            margin-top: 25px;
            width: 90%;
            max-width: 400px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            font-size: 0.85rem;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 6px; border-bottom: 1px solid #eee; }
        th { color: #0073b1; }
    </style>
</head>
<body>

    <h1>Mechanical Speed Audit</h1>
    <div class="subtitle">Detailed breakdown of time spent between taps.</div>

    <div id="timer">0.000s</div>

    <div id="game-container">
        <div id="grid-cover">
            <button class="btn" onclick="startGame()">START TEST</button>
        </div>
        <div id="queens-grid"></div>
    </div>

    <div id="stats-panel">
        <h3>Input Analytics</h3>
        <table id="stats-table">
            <thead>
                <tr>
                    <th>Queen</th>
                    <th>Tap Interval</th>
                    <th>Travel Time</th>
                </tr>
            </thead>
            <tbody id="stats-body"></tbody>
        </table>
        <p style="font-size: 0.75rem; color: #888; margin-top: 10px;">
            * <b>Tap Interval:</b> Time between 1st and 2nd tap on the same queen.<br>
            * <b>Travel Time:</b> Time between finishing one queen and 1st tapping the next.
        </p>
    </div>

    <script>
        const gridColors = [
            ['purple', 'orange', 'orange', 'blue', 'blue', 'blue', 'blue'],
            ['purple', 'purple', 'orange', 'green', 'green', 'blue', 'blue'],
            ['purple', 'orange', 'orange', 'green', 'grey', 'grey', 'blue'],
            ['purple', 'purple', 'orange', 'green', 'grey', 'blue', 'blue'],
            ['purple', 'orange', 'orange', 'green', 'grey', 'grey', 'blue'],
            ['red', 'green', 'green', 'green', 'grey', 'grey', 'blue'],
            ['red', 'red', 'yellow', 'yellow', 'grey', 'grey', 'blue']
        ];

        const queenPositions = [[0, 2], [1, 4], [2, 6], [3, 1], [4, 5], [5, 0], [6, 3]];

        let startTime, timerActive = false, rafId;
        let queensFound = 0;
        let lastTapTime = 0, lastTapCell = null;
        
        // Stats Tracking
        let lastCompletionTime = 0; // Time of previous queen's second tap
        let currentQueenFirstTap = 0; 
        let statsData = [];

        function createGrid() {
            const gridContainer = document.getElementById('queens-grid');
            for (let r = 0; r < 7; r++) {
                for (let c = 0; c < 7; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell color-${gridColors[r][c]}`;
                    if (c < 6 && gridColors[r][c] !== gridColors[r][c+1]) cell.classList.add('thick-border-right');
                    if (r < 6 && gridColors[r][c] !== gridColors[r+1][c]) cell.classList.add('thick-border-bottom');

                    const isQueen = queenPositions.some(pos => pos[0] === r && pos[1] === c);
                    if (isQueen) {
                        cell.innerHTML = '<span class="queen-icon">♛</span>';
                        cell.dataset.isQueen = "true";
                    } else {
                        cell.innerHTML = '<span class="mark">×</span>';
                    }

                    cell.addEventListener('pointerdown', function() {
                        if (!timerActive) return;
                        const now = performance.now();
                        const timespan = now - lastTapTime;

                        if (timespan < 350 && lastTapCell === this) {
                            // SECOND TAP (Completion of Queen)
                            if (this.dataset.isQueen === "true" && !this.classList.contains('found')) {
                                this.classList.add('found');
                                queensFound++;
                                
                                const tapInterval = now - currentQueenFirstTap;
                                const travelTime = currentQueenFirstTap - (lastCompletionTime || startTime);
                                
                                statsData.push({
                                    queen: queensFound,
                                    interval: tapInterval.toFixed(0),
                                    travel: travelTime.toFixed(0)
                                });

                                lastCompletionTime = now; 
                                checkWin();
                            }
                            lastTapTime = 0;
                            lastTapCell = null;
                        } else {
                            // FIRST TAP
                            lastTapTime = now;
                            lastTapCell = this;
                            currentQueenFirstTap = now;
                        }
                    });
                    gridContainer.appendChild(cell);
                }
            }
        }

        function startGame() {
            queensFound = 0;
            statsData = [];
            lastCompletionTime = 0;
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('found'));
            document.getElementById('grid-cover').style.display = 'none';
            document.getElementById('stats-panel').style.display = 'none';
            timerActive = true;
            startTime = performance.now();
            rafId = requestAnimationFrame(updateTimer);
        }

        function updateTimer() {
            if (!timerActive) return;
            const elapsed = (performance.now() - startTime) / 1000;
            document.getElementById('timer').textContent = elapsed.toFixed(3) + 's';
            rafId = requestAnimationFrame(updateTimer);
        }

        function checkWin() {
            if (queensFound === queenPositions.length) {
                timerActive = false;
                cancelAnimationFrame(rafId);
                displayStats();
                document.getElementById('grid-cover').style.display = 'flex';
                document.querySelector('.btn').textContent = "RE-TEST";
            }
        }

        function displayStats() {
            const body = document.getElementById('stats-body');
            body.innerHTML = '';
            statsData.forEach(s => {
                const row = `<tr>
                    <td>#${s.queen}</td>
                    <td>${s.interval}ms</td>
                    <td>${s.travel}ms</td>
                </tr>`;
                body.innerHTML += row;
            });
            document.getElementById('stats-panel').style.display = 'block';
        }

        createGrid();
    </script>
</body>
</html>
